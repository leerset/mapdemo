<!DOCTYPE html>
<html>
<head>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
		#l-map{height:85%;width:100%;}
		.anchorBL{display:none;}
		/*地图标题*/

    .BMap_bubble_title{
        color:black;
        font-size:30px;
        font-weight: bold;
        text-align:left;
    }
    .BMap_pop div:nth-child(1){
        border-radius:20px 0 0 0;
    }
    .BMap_pop div:nth-child(3){
        border-radius:0 20px 0 0;
    }
    .BMap_pop div:nth-child(3) div{
        border-radius:0 20px 0 0;
    }
		.BMap_pop div:nth-child(5){
        border-radius:0 0 0 20px;
    }
    .BMap_pop div:nth-child(5) div{
        border-radius:0 0 0 20px;
    }
    .BMap_pop div:nth-child(7){
        border-radius:0 0 20px 0;
    }
	</style>
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link type="text/css" href="styles.css" rel="Stylesheet">
	<link href="data/styles.css" type="text/css" rel="stylesheet">
	<script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=6YEOGgEs5NGQHvg36wFHyMsj5E07xnTU&s=1"></script>
	<title>DEMO</title>
</head>
<body>

	<div style="width:94%;height:850px;margin:2%;padding:1%;border-color:black;border-width:1px;border-style:solid;">
		<div id="title" style="height:8%;">
			<img class="img" style="height:100%;float:left;" src="images/pipe_green.png"></img>
			<div id="text" class="text" style="height:40px;font-size:30px;float:left;margin:15px;">
				<!-- <span>流域水环境精细化管理决策支持系统</sapn> -->
					<span>流域水环境DEMO</sapn>
					</div>
		</div>
		<div>
			<hr style="width:100%;height:1px;border:none;border-top:1px double black;" />
		</div>
		<div id="l-map"></div>
		<div id="r-result">
			<input type="button" onclick="hideOver()" value="清空" />
			<input type="button" onclick="addDrops()" value="添加点" />
			<input type="button" onclick="addPipes()" value="添加管道" />
			<input type="button" onclick="addBoxes()" value="添加河面" />
			<input type="button" onclick="addLines()" value="添加线" />
			<input type="button" onclick="addEreas(6)" value="添加面" />
			<input type="button" onclick="removeEreas(6)" value="移除面" />
			<input type="button" onclick="addFlow()" value="添加流水" />
			<input type="button" onclick="removeFlow()" value="移除流水" />
			<input type="button" onclick="addOver()" value="添加覆盖物" />
		</div>
	</div>
</body>
</html>
<script type="text/javascript">
	// 百度地图API功能

  var map;
	// map.setMapStyle({style: 'light'});
	var centrPoint = new BMap.Point(114.0515977283,22.5199590014);
	initMap();

//创建和初始化地图函数：
  function initMap(){
    createMap();//创建地图
    setMapEvent();//设置地图事件
		// map.enableScrollWheelZoom();    	//启用滚轮放大缩小，默认禁用
    // map.disableDragging();           		//禁用地图拖拽，默认启用
		// map.enableKeyboard();         		//启用键盘操作，默认禁用。
    map.disableDoubleClickZoom();      	//禁用双击放大，默认启用
		// BMap.setCustomMapStylePath("custom_map_config.json");
  }

  function createMap(){
		map = new BMap.Map("l-map",{enableMapClick:false});
		map.centerAndZoom(centrPoint,16);
  }

  function setMapEvent(){
  }

  function addClickHandler(target, window){
    target.addEventListener("click",function(){
      target.openInfoWindow(window);
    });
  }

	var dropIcons = [];
	dropIcons.push(new BMap.Icon("images/drop_green.png", new BMap.Size(40,40)
		,{
			offset: new BMap.Size(0, 0), // 指定定位位置
			imageOffset: new BMap.Size(10, 0) // 设置图片偏移
		}
	));
	dropIcons.push(new BMap.Icon("images/drop_red.png", new BMap.Size(40,40)	,{
			offset: new BMap.Size(0, 0), // 指定定位位置
			imageOffset: new BMap.Size(10, 0) // 设置图片偏移
		}
	));
	dropIcons.push(new BMap.Icon("images/drop_orange.png", new BMap.Size(40,40)	,{
			offset: new BMap.Size(0, 0), // 指定定位位置
			imageOffset: new BMap.Size(10, 0) // 设置图片偏移
		}
	));
	dropIcons.push(new BMap.Icon("images/drop_grey.png", new BMap.Size(40,40)	,{
			offset: new BMap.Size(0, 0), // 指定定位位置
			imageOffset: new BMap.Size(10, 0) // 设置图片偏移
		}
	));

	// 管道图标
	var pipeIcons = [];
	pipeIcons.push(new BMap.Icon("images/pipe_green.png", new BMap.Size(20,20)));
	pipeIcons.push(new BMap.Icon("images/pipe_grey.png", new BMap.Size(20,20)));
	pipeIcons.push(new BMap.Icon("images/pipe_orange.png", new BMap.Size(20,20)));
	pipeIcons.push(new BMap.Icon("images/pipe_red.png", new BMap.Size(20,20)));

	// 河面图标
	var boxIcons = [];
	boxIcons.push(new BMap.Icon("images/box_green.png", new BMap.Size(20,20)));
	boxIcons.push(new BMap.Icon("images/box_grey.png", new BMap.Size(20,20)));
	boxIcons.push(new BMap.Icon("images/box_orange.png", new BMap.Size(20,20)));
	boxIcons.push(new BMap.Icon("images/box_red.png", new BMap.Size(20,20)));

	var points = [];	// 水滴图标

	// 区域圆心
	var areaO1 = new BMap.Point(114.0469272065,22.5191553878);
	var areaO2 = new BMap.Point(114.0478677201,22.5232816411);
	var areaO3 = new BMap.Point(114.0498632836,22.5280784373);
	var areaO4 = new BMap.Point(114.0531855960,22.5154790956);
	var areaO5 = new BMap.Point(114.0566152307,22.5219838553);
	var areaO6 = new BMap.Point(114.0584820482,22.5259085518);
	var areaO7 = new BMap.Point(114.0564006540,22.5286240594);

	var ereas = [];
	var areaCenterPoints = [areaO1,areaO2,areaO3,areaO4,areaO5,areaO6,areaO7];
	var rads = [125,215,285,175,215,245,135];

	var polylines = [];
	var linePoints = [
		new BMap.Point(114.055009,22.525749),
		new BMap.Point(114.054973,22.525682),
		new BMap.Point(114.054901,22.525582),
		new BMap.Point(114.054865,22.525515),
		new BMap.Point(114.054793,22.525449),
		new BMap.Point(114.054757,22.525315),
		new BMap.Point(114.054686,22.525248),
		new BMap.Point(114.054614,22.525148),
		new BMap.Point(114.054578,22.525081),
		new BMap.Point(114.054506,22.524948),
		new BMap.Point(114.054398,22.524848),
		new BMap.Point(114.05429,22.524714),
		new BMap.Point(114.054254,22.524614),
		new BMap.Point(114.054183,22.52448),
		new BMap.Point(114.054183,22.52438),
		new BMap.Point(114.054147,22.524314),
		new BMap.Point(114.054147,22.52418),
		new BMap.Point(114.054039,22.52408),
		new BMap.Point(114.053967,22.52398),
		new BMap.Point(114.053895,22.52388),
		new BMap.Point(114.053823,22.523779),
		new BMap.Point(114.053751,22.523713),
		new BMap.Point(114.053679,22.523579),
		new BMap.Point(114.053608,22.523479),
		new BMap.Point(114.053536,22.523345),
		new BMap.Point(114.053464,22.523245),
		new BMap.Point(114.053392,22.523112),
		new BMap.Point(114.05332,22.523045),
		new BMap.Point(114.053248,22.522911),
		new BMap.Point(114.053212,22.522778),
		new BMap.Point(114.053105,22.522678),
		new BMap.Point(114.053033,22.522511),
		new BMap.Point(114.052925,22.522411),
		new BMap.Point(114.052853,22.522277),
		new BMap.Point(114.052781,22.52211),
		new BMap.Point(114.052673,22.522043),
		new BMap.Point(114.052601,22.52191),
		new BMap.Point(114.052566,22.52181),
		new BMap.Point(114.052458,22.521643),
		new BMap.Point(114.052422,22.521576),
		new BMap.Point(114.05235,22.521509),
		new BMap.Point(114.052314,22.521409),
		new BMap.Point(114.05217,22.521242),
		new BMap.Point(114.052134,22.521175),
		new BMap.Point(114.052134,22.521175),
		new BMap.Point(114.052027,22.521008),
		new BMap.Point(114.051991,22.520908),
		new BMap.Point(114.051883,22.520808),
		new BMap.Point(114.051847,22.520675),
		new BMap.Point(114.051739,22.520574),
		new BMap.Point(114.051667,22.520441),
		new BMap.Point(114.051631,22.520274),
		new BMap.Point(114.051559,22.520174),
		new BMap.Point(114.051559,22.520007),
		new BMap.Point(114.051524,22.519873),
		new BMap.Point(114.051488,22.51974),
		new BMap.Point(114.051452,22.519473),
		new BMap.Point(114.05138,22.519306),
		new BMap.Point(114.051308,22.519172),
		new BMap.Point(114.051236,22.519039),
		new BMap.Point(114.051128,22.518838),
		new BMap.Point(114.051056,22.518705),
		new BMap.Point(114.050949,22.518538),
		new BMap.Point(114.050841,22.518371),
		new BMap.Point(114.050733,22.518238),
		new BMap.Point(114.050625,22.518071),
		new BMap.Point(114.050517,22.517937),
		new BMap.Point(114.050446,22.517803),
		new BMap.Point(114.050302,22.517637),
		new BMap.Point(114.050194,22.51747),
		new BMap.Point(114.05005,22.517269),
		new BMap.Point(114.049943,22.517036),
		new BMap.Point(114.049835,22.516869),
		new BMap.Point(114.049727,22.516635),
		new BMap.Point(114.049583,22.516368),
		new BMap.Point(114.049439,22.516201),
		new BMap.Point(114.049296,22.515967),
		new BMap.Point(114.049152,22.515767),
		new BMap.Point(114.04908,22.5155),
		new BMap.Point(114.048972,22.515266),
		new BMap.Point(114.048865,22.515099),
		new BMap.Point(114.048757,22.514966),
		new BMap.Point(114.048685,22.514866),
		new BMap.Point(114.048541,22.514699),
		new BMap.Point(114.048397,22.514465),
		new BMap.Point(114.048254,22.514298),
		new BMap.Point(114.048146,22.514031),
		new BMap.Point(114.048038,22.513831),
		new BMap.Point(114.047894,22.513664),
		new BMap.Point(114.047787,22.513497),
		new BMap.Point(114.047679,22.51333),
		new BMap.Point(114.047571,22.513196),
		new BMap.Point(114.047463,22.512996),
		new BMap.Point(114.047355,22.512796),
		new BMap.Point(114.047176,22.512695),
		new BMap.Point(114.047068,22.512428),
		new BMap.Point(114.046924,22.512195),
		new BMap.Point(114.04678,22.511961),
		new BMap.Point(114.046529,22.511727),
		new BMap.Point(114.046385,22.511493),
		new BMap.Point(114.046206,22.511326),
		new BMap.Point(114.046062,22.511093),
		new BMap.Point(114.045882,22.510926),
		new BMap.Point(114.045738,22.510592),
		new BMap.Point(114.045595,22.510358),
		new BMap.Point(114.045451,22.510258),
		new BMap.Point(114.045271,22.510024),
		new BMap.Point(114.04502,22.509791),
		new BMap.Point(114.04502,22.509791),
		new BMap.Point(114.04502,22.509791),
		new BMap.Point(114.04502,22.509791)
	];

	var rivierAreaPoints = [
		new BMap.Point(114.054805,22.526036),
		new BMap.Point(114.055416,22.525769),
		new BMap.Point(114.052254,22.520461),
		new BMap.Point(114.051859,22.518992),
		new BMap.Point(114.046109,22.50961),
		new BMap.Point(114.044169,22.509911),
		new BMap.Point(114.050709,22.519393),
		new BMap.Point(114.050888,22.52006),
		new BMap.Point(114.05096,22.520695),
		new BMap.Point(114.054805,22.526036),
		new BMap.Point(114.054805,22.526036)
  ]

	var plOpts = [];

	var pipeAreaPoints = [
			[
				 new BMap.Point(114.04787,22.518491),
				 new BMap.Point(114.049379,22.517456),
				 new BMap.Point(114.049739,22.518124),
				 new BMap.Point(114.048158,22.519025),
				 new BMap.Point(114.04787,22.518491)
	 	 	],
		 	[
				 new BMap.Point(114.049271,22.52193),
				 new BMap.Point(114.051104,22.520928),
				 new BMap.Point(114.051535,22.521563),
				 new BMap.Point(114.049775,22.522497),
				 new BMap.Point(114.049271,22.52193)
		 	],
			[
 				 new BMap.Point(114.05229,22.526871),
				 new BMap.Point(114.054374,22.525569),
				 new BMap.Point(114.054697,22.526003),
				 new BMap.Point(114.052541,22.527238),
				 new BMap.Point(114.05229,22.526871)
		 	],
		  [
				 new BMap.Point(114.050601,22.517056),
				 new BMap.Point(114.05017,22.516154),
				 new BMap.Point(114.051427,22.51582),
				 new BMap.Point(114.051715,22.516588),
				 new BMap.Point(114.050601,22.517056),
		 	],
			[
				new BMap.Point(114.05441,22.523866),
				 new BMap.Point(114.055128,22.523365),
				 new BMap.Point(114.054877,22.522998),
				 new BMap.Point(114.05405,22.523399),
				 new BMap.Point(114.05441,22.523866)
		 	],
			[
					new BMap.Point(114.055272,22.525802),
          new BMap.Point(114.056135,22.525836),
          new BMap.Point(114.056242,22.525335),
          new BMap.Point(114.0552,22.525335),
          new BMap.Point(114.055272,22.525802)
		 	],
			[
				 new BMap.Point(114.055596,22.527672),
				 new BMap.Point(114.056027,22.527505),
				 new BMap.Point(114.055308,22.525903),
				 new BMap.Point(114.054805,22.52607),
				 new BMap.Point(114.055596,22.527672)
		 	],
	];

	var ereaPoints = [
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
		[
			new BMap.Point(114.056912,22.527972),
			new BMap.Point(114.056085,22.52854),
			new BMap.Point(114.057127,22.52884),
			new BMap.Point(114.05666,22.529007)
		],
	]

	var pipePoints = [
				 [new BMap.Point(114.047888,22.518775),
          new BMap.Point(114.048238,22.518587),
          new BMap.Point(114.048616,22.518362),
          new BMap.Point(114.048993,22.518162),
          new BMap.Point(114.049379,22.517953),
          new BMap.Point(114.049721,22.517761),
          new BMap.Point(114.049999,22.517611),
          new BMap.Point(114.050251,22.517452)],
					[new BMap.Point(114.049442,22.522293),
          new BMap.Point(114.049712,22.522151),
          new BMap.Point(114.050035,22.522001),
          new BMap.Point(114.050376,22.521842),
          new BMap.Point(114.050691,22.5217),
          new BMap.Point(114.051005,22.521559),
          new BMap.Point(114.051302,22.521417),
          new BMap.Point(114.051562,22.521291),
          new BMap.Point(114.051832,22.52115),
          new BMap.Point(114.052065,22.521033)],
					[new BMap.Point(114.05198,22.527296),
          new BMap.Point(114.052285,22.527129),
          new BMap.Point(114.052654,22.526854),
          new BMap.Point(114.053004,22.526712),
          new BMap.Point(114.053354,22.526512),
          new BMap.Point(114.053687,22.526328),
          new BMap.Point(114.054019,22.526186),
          new BMap.Point(114.054324,22.526036),
          new BMap.Point(114.054639,22.525844),
          new BMap.Point(114.054944,22.525652)],
					[new BMap.Point(114.051845,22.516054),
          new BMap.Point(114.051504,22.516188),
          new BMap.Point(114.051171,22.516321),
          new BMap.Point(114.050857,22.516463),
          new BMap.Point(114.050543,22.516572),
          new BMap.Point(114.050201,22.51668),
          new BMap.Point(114.049932,22.516805),
          new BMap.Point(114.049932,22.516822)],
					[new BMap.Point(114.055263,22.52299),
          new BMap.Point(114.054913,22.523132),
          new BMap.Point(114.054643,22.523257),
          new BMap.Point(114.054383,22.523365),
          new BMap.Point(114.054176,22.523457),
          new BMap.Point(114.053934,22.523566),
          new BMap.Point(114.053718,22.523666)],
					[new BMap.Point(114.056395,22.525573),
          new BMap.Point(114.056117,22.525577),
          new BMap.Point(114.05582,22.525569),
          new BMap.Point(114.055569,22.525577),
          new BMap.Point(114.055272,22.525569),
          new BMap.Point(114.054949,22.525585)],
					[new BMap.Point(114.055977,22.527739),
          new BMap.Point(114.055834,22.527488),
          new BMap.Point(114.055681,22.52723),
          new BMap.Point(114.055537,22.526913),
          new BMap.Point(114.055438,22.526679),
          new BMap.Point(114.055322,22.526437),
          new BMap.Point(114.055196,22.526195),
          new BMap.Point(114.055061,22.525986),
          new BMap.Point(114.054953,22.525736)],

	]

	var boxPoints = [
		linePoints[9],
		linePoints[23],
		linePoints[42],
		linePoints[57],
		linePoints[72],
		linePoints[84],
		linePoints[99]
	];

	var boxHash = {}
	boxPoints.forEach(function (point) {
		boxHash[[point.lng, point.lat]] = 0;
	})

	// var polyline = new BMap.Polyline(boxPoints, {strokeColor:"#78cdd1", strokeWeight:15, strokeOpacity:0});

	var pl1 = new BMap.Polyline([
		areaO1,
		new BMap.Point(114.0488154816,22.5155873085)
	], {strokeColor:"#78cdd1", strokeWeight:5, strokeOpacity:0});

	var pl2 = new BMap.Polyline([
		areaO2,
		new BMap.Point(114.0512831139,22.5196311248)
	], {strokeColor:"#78cdd1", strokeWeight:5, strokeOpacity:0});

	var pl3 = new BMap.Polyline([
		areaO3,
		new BMap.Point(114.0536540720,22.5234506741)
	], {strokeColor:"#78cdd1", strokeWeight:5, strokeOpacity:0});

	hideOver();

	function randomNumber(min, max, accuraty) {
		var number = Math.random() * (max - min) + min;
		return number.toFixed(accuraty);
	}

	var infoWindows = [];

	function setContent(len) {
		infoWindows = [];
		for (var i=0; i<len; i++) {
			let sContent = "<div id=\"uuuu\" style=\"width:400px;\" class=\"ax_default\">" +
			"  <div id=\"uuuu\" class=\"col-xs-12\">" +
			"    <div id=\"uuuu_div\" class=\"\"></div>" +
			"    <!-- Unnamed () -->" +
			"    <div id=\"uuuu\" class=\"text\" style=\"visibility: visible;\">" +
			"      <p style=\"font-size:18px;\"><span>" +i+ "号监测点</span><span style=\"font-size:13px;\"></span></p><p style=\"font-size:13px;\"><span>实时数据</span></p><p style=\"font-size:13px;\"><span><br></span></p>" +
			"    </div>" +
			"  </div>" +
			"  <div id=\"uuuu\" class=\"col-xs-5\">" +
			"    <div id=\"uuuu_div\" class=\"\"></div>" +
			"    <div id=\"uuuu\" class=\"text\" style=\"visibility: visible; top: 7px; transform-origin: 59.5px 38px 0px;\">" +
			"      <p><span>水位：" +randomNumber(20, 30, 2)+ " cm</span></p><p><span>流速：" +randomNumber(2, 5, 2)+ " m/s</span></p><p><span>瞬时流速：" +randomNumber(2, 5, 2)+ "m/s</span></p><p><span>pH：" +randomNumber(1, 13, 1)+ "</span></p>" +
			"    </div>" +
			"  </div>" +
			"  <div id=\"uuuu\" class=\"col-xs-7\">" +
			"    <div id=\"uuuu_div\" class=\"\"></div>" +
			"    <div id=\"uuuu\" class=\"text\" style=\"visibility: visible; top: -12px; transform-origin: 59.5px 57px 0px;\">" +
			"      <p><span>COD：" +randomNumber(5, 20, 0)+ " mg/l</span></p><p><span>氨氮：" +randomNumber(0, 2, 3)+ " mg/l</span></p><p><span>六价铬：" +randomNumber(0, 2, 3)+ " mg/l</span></p><p><span>总磷：" +randomNumber(0, 2, 3)+ " mg/l</span></p><p><span>总铜：" +randomNumber(0, 2, 3)+ " mg/l</span></p><p><span>总镍：" +randomNumber(0, 2, 3)+ " mg/l</span></p>" +
			"    </div>" +
			"  </div>" +
			"</div>";
			infoWindows.push(new BMap.InfoWindow(sContent));  // 创建信息窗口对象
		}
	}

	///////////////////////////////////////////////////////////////////////////////////

	function hideOver(){
		map.clearOverlays();
	}

	function addDrops(){
		// 随机向地图添加标注
		setContent(100);
		for (var i = 0; i < 3; i ++) {
			for (var j = 0; j < 3; j ++) {
				var point = areaCenterPoints[j];
				var rad = rads[j] / 56572.0;
				var pointR = new BMap.Point(point.lng + rad * (Math.random() * 0.8) - rad * (Math.random() * 0.8), point.lat + rad * (Math.random() * 0.8) - rad * (Math.random() * 0.8));
				var idx = parseInt(Math.random() * 4);
				let markerR = new BMap.Marker(pointR,{icon:dropIcons[idx]});
				let infoWindow = infoWindows[i*7+j];
				map.addOverlay(markerR);
				markerR.addEventListener("click", function(){
					// var marker = new BMap.Marker(point);
					// map.addOverlay(marker);
				   this.openInfoWindow(infoWindow);
					 // infoWindow.redraw();
				   //图片加载完毕重绘infowindow
				   // document.getElementById('imgDemo').onload = function (){
					 //   infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
				   // }
				});

			}
		}
		areaCenterPoints.forEach(function (point) {
			// var markerR = new BMap.Marker(point);
			// map.addOverlay(markerR);
		})
	}
	function addPipes(){
		// 随机向地图添加标注
		pipePoints.forEach(function (points) {
			var idx = parseInt(Math.random() * 4);
			var markerR = new BMap.Marker(points[0],{icon:pipeIcons[idx]});
			map.addOverlay(markerR);
		})
	}

	function addBoxes(){
		// 随机向地图添加标注
		boxPoints.forEach(function (point) {
			var idx = parseInt(Math.random() * 4);
			boxHash[[point.lng, point.lat]] = idx + 1;
			var markerR = new BMap.Marker(point,{icon:boxIcons[idx]});
			map.addOverlay(markerR);
		})
	}

	function addLines(){
		// map.addOverlay(polyline);
		map.addOverlay(pl1);
		map.addOverlay(pl2);
		map.addOverlay(pl3);
	}

	function initEreas() {
		ereas = [];
		for(i=0;i<areaCenterPoints.length;i++){
			var c = new BMap.Circle(areaCenterPoints[i], rads[i], {strokeColor:"blue", strokeWeight:0, strokeOpacity:0,fillOpacity: 0.8, fillColor: "#FFFFFF"});
			var circlePoints = getCirclePoints(areaCenterPoints[i].lng, areaCenterPoints[i].lat, rads[i]);
			var ps = []
			var ne = new BMap.Point(113.834155, 22.413675);
			var sw = new BMap.Point(114.274827, 22.616664);
			ps.push(new BMap.Point(ne.lng,ne.lat))
			ps.push(new BMap.Point(sw.lng,ne.lat))
			ps.push(new BMap.Point(sw.lng,sw.lat))
			ps.push(new BMap.Point(ne.lng,sw.lat))
			ps.push(new BMap.Point(ne.lng,ne.lat))
			ps = ps.concat(circlePoints)
			ps.push(new BMap.Point(ne.lng,ne.lat))
			ps = ps.concat(rivierAreaPoints)
			ps.push(new BMap.Point(ne.lng,ne.lat))
			ps = ps.concat(pipeAreaPoints[i])
			ps.push(new BMap.Point(ne.lng,ne.lat))

			// var curve = new BMapLib.CurveLine(ps.reverse(), {strokeColor:"blue", strokeWeight:1, strokeOpacity:0.5}); //创建弧线对象
			var curve = new BMap.Polygon(ps, {strokeColor:"none", strokeWeight:1, strokeOpacity:0.5, fillColor: "rgb(0,0,0)", fillOpacity:0.3}); //创建弧线对象
			ereas.push(curve);
		}
	}
	initEreas();

	function addEreas(i){
		// ereas.forEach(function (e) {map.addOverlay(e);})
		map.addOverlay(ereas[i]);
		// map.panTo(areaCenterPoints[3]);
	}

	function removeEreas(i){
		// ereas.forEach(function (e) {map.addOverlay(e);})
		map.removeOverlay(ereas[i]);
		// map.panTo(areaCenterPoints[3]);
	}

	var flow = false;

	function getDistance2(point1, point2) {
		return getDistance(point1.lat, point1.lng, point2.lat, point2.lng);
	}

	function getDistance(lat1, lng1, lat2, lng2) {
	 earthRadius = 6367000; //地球半径m

	 lat1 = (lat1 * Math.PI ) / 180;
	 lng1 = (lng1 * Math.PI ) / 180;

	 lat2 = (lat2 * Math.PI ) / 180;
	 lng2 = (lng2 * Math.PI ) / 180;

	 calcLongitude = lng2 - lng1;
	 calcLatitude = lat2 - lat1;
	 stepOne = Math.pow(Math.sin(calcLatitude / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(calcLongitude / 2), 2);
	 stepTwo = 2 * Math.asin(Math.min(1, Math.sqrt(stepOne)));
	 calculatedDistance = earthRadius * stepTwo;

	 return Math.round(calculatedDistance, 6);
	}

	function splitPoints(point1, point2, offset = 50) {
		let points = [];
		// points.push(point1);
		let dist = getDistance2(point1, point2);
		let pieces = Math.round(dist / offset);
		if (pieces <= 1) {
			// points.push(point2);
			return points;
		} else {
			let raidus = Math.round(dist / pieces);
			let degree = (24901 * 1609) / 360.0;
			let dpmLat = 1 / degree;
			let mpdLng = degree * Math.cos(point1.lat * (Math.PI / 180));
			let dpmLng = 1 / mpdLng;
			let radiusLat = dpmLat * raidus;
			let radiusLng = dpmLng * raidus;
			let cos = (point2.lng - point1.lng) / radiusLng;
			let sin = (point2.lat - point1.lat) / radiusLat;
			let a = Math.atan(sin / cos);
			console.log("sin=" + sin);
			console.log("cos=" + cos);
			console.log("a=" + a);
			// let minLng = Math.min(point1.lng, point2.lng);
			// let minLat = Math.min(point1.lat, point2.lat);
			let minLng = point1.lng;
			let minLat = point1.lat;
			for ( let i = 1; i < pieces; i++ ) {
				let ln = parseFloat((minLng + i * radiusLng * Math.cos(a) * cos / Math.abs(cos)).toFixed(6))
				let la = parseFloat((minLat + i * radiusLat * Math.sin(a) * sin / Math.abs(sin)).toFixed(6))
				let newPoint = new BMap.Point(ln, la)
				points.push(newPoint);
			}
			// points.push(point2);
			return points;
		}
	}

	function getSidePoints(point1, point2, point3, raidus = 100) {
		let sidePoints = [];
		let degree = (24901 * 1609) / 360.0;
		let dpmLat = 1 / degree;
		let mpdLng = degree * Math.cos(point1.lat * (Math.PI / 180));
		let dpmLng = 1 / mpdLng;
		let radiusLat = dpmLat * raidus;
		let radiusLng = dpmLng * raidus;
		let cos = (point2.lng - point3.lng) / radiusLng;
		let sin = (point2.lat - point3.lat) / radiusLat;
		let a = Math.atan(sin / cos);
		let b = (a * 180 / Math.PI + 90) * Math.PI / 180;
		let minLng = point1.lng;
		let minLat = point1.lat;
		let ln1 = parseFloat((minLng + 1 * radiusLng * Math.cos(b)).toFixed(6))
		let la1 = parseFloat((minLat + 1 * radiusLat * Math.sin(b)).toFixed(6))
		sidePoints.push(new BMap.Point(ln1, la1));
		let ln2 = parseFloat((minLng - 1 * radiusLng * Math.cos(b)).toFixed(6))
		let la2 = parseFloat((minLat - 1 * radiusLat * Math.sin(b)).toFixed(6))
		sidePoints.push(new BMap.Point(ln2, la2));
		return sidePoints;
	}

	function extendPoints(pointArray, offset = 50) {
		let retPoints = [];
		for (let i = 0; i < pointArray.length; i++ ) {
			p = pointArray[i];
			if ( i == 0 ) {
				retPoints.push(p);
			} else {
				retPoints = retPoints.concat(splitPoints(pointArray[i-1], p, offset));
				retPoints.push(p);
			}
		}
		return retPoints;
	}

	function coverPoints(pointArray, radius = 100) {
		if (pointArray.length <= 1) { return pointArray}
		let retPoints = [];
		for (let i = 0; i < pointArray.length; i++ ) {
			p = pointArray[i];
			if ( i == 0 ) {
				retPoints.push(getSidePoints(p,pointArray[1],p,radius));
			} else if (i == pointArray.length - 1) {
				retPoints.push(getSidePoints(p,pointArray[i-1],p,radius));
			} else {
				retPoints.push(getSidePoints(p,pointArray[i-1],pointArray[i+1],radius));
			}
		}
		return retPoints;
	}

a = boxPoints
b = coverPoints(a,100)
riverCoverPoints = []
for (let i = 0; i < b.length; i++ ) {
	riverCoverPoints.push(b[i][0])
}
for (let i = b.length - 1; i >= 0; i-- ) {
	riverCoverPoints.push(b[i][1])
}
riverCoverPoints.push(b[0][0])
polyline = new BMap.Polyline(riverCoverPoints, {strokeColor:"#78cdd1", strokeWeight:15, strokeOpacity:0});
map.addOverlay(polyline);
addMarker(boxPoints);

	function addFlow() {
		plOpts = [];
		var idx = 0;
		var color = "green";
		for (var a = 0; a < linePoints.length; a ++) {
			var point = linePoints[a];
			if (boxHash[[point.lng,point.lat]]) { idx = boxHash[[point.lng,point.lat]]; }
			if (idx == 0) { color = "green"}
			if (idx == 1) { color = "green"}
			if (idx == 2) { color = "grey"}
			if (idx == 3) { color = "orange"}
			if (idx == 4) { color = "red"}
			plOpts.push({strokeColor:color, strokeWeight:5 + a / map.Va, strokeOpacity:"0.4"});
			// plOpts.push({strokeColor:color, strokeWeight:7, strokeOpacity:"0.4"});
		}
		addPolylines();
		flow = true;
		adynamicLines();
	}

	function getCirclePoints(lng, lat, raidus) {
		var circlePoints = [];
		var degree = (24901 * 1609) / 360.0;
    var dpmLat = 1 / degree;
		var mpdLng = degree * Math.cos(lat * (Math.PI / 180));
		var dpmLng = 1 / mpdLng;

		var radiusLat = dpmLat * raidus;
		var minLat = lat - radiusLat;
		var maxLat = lat + radiusLat;

		var radiusLng = dpmLng * raidus;
		var minLng = lng - radiusLng;
		var maxLng = lng + radiusLng;
		for (var a = 270; a <= 270 + 360; a += 10) {
			var cos = Math.cos(a / 180 * Math.PI);
			var sin = Math.sin(a / 180 * Math.PI);
			// if (a == 0) { sin = 0; cos = 1;}
			// if (a == 90) { sin = 1; cos = 0;}
			// if (a == 180) { sin = 0; cos = -1;}
			// if (a == 270) { sin = -1; cos = 0;}
			// if (a == 360) { sin = 0; cos = 1;}
			// if (a == 30) { sin = 0.5;}
			// if (a == 210) { sin = -0.5;}
			// if (a == 60) { cos = 0.5;}
			// if (a == 240) { cos = -0.5;}
			var ln = parseFloat((lng + radiusLng * cos).toFixed(6))
			var la = parseFloat((lat + radiusLat * sin).toFixed(6))
			if ( circlePoints.length > 0 &&
				   la == circlePoints[circlePoints.length - 1].lat) {
				la += 0.000001;
			}
			if ( circlePoints.length > 0 &&
				   ln == circlePoints[circlePoints.length - 1].lng) {
				ln += 0.000001;
			}
			circlePoints.push(new BMap.Point(ln, la))
		}
		// for (var a = 121; a <= 240; a += 60) {
		// 	circlePoints.push(new BMap.Point(lng + radiusLng * Math.cos(a / 180 * Math.PI), lat + radiusLat * Math.sin(a / 180 * Math.PI)))
		// }
		return circlePoints;
	}

	function addOver() {
		var points = getCirclePoints(114.049667, 22.516488, 500);
		var ps = []
		var ne = new BMap.Point(113.834155, 22.413675);
		var sw = new BMap.Point(114.274827, 22.616664);
		ps.push(new BMap.Point(ne.lng,ne.lat))
		ps.push(new BMap.Point(sw.lng,ne.lat))
		ps.push(new BMap.Point(sw.lng,sw.lat))
		ps.push(new BMap.Point(ne.lng,sw.lat))
		ps.push(new BMap.Point(ne.lng,ne.lat))
		ps = ps.concat(points)
		ps.push(new BMap.Point(ne.lng,ne.lat))

		// var curve = new BMapLib.CurveLine(ps.reverse(), {strokeColor:"blue", strokeWeight:1, strokeOpacity:0.5}); //创建弧线对象
		var curve = new BMap.Polygon(ps, {strokeColor:"none", strokeWeight:1, strokeOpacity:0.5, fillColor: "rgb(0,0,0)", fillOpacity:0.5}); //创建弧线对象
		map.addOverlay(curve);
		map.Va = 17;
		map.panTo( new BMap.Point(114.049667, 22.516488));
	}

	function addPolylines(){
		for(var i = 0; i < linePoints.length - 2; i++){
			var polyline = new BMap.Polyline([linePoints[i],linePoints[i+1]],plOpts[i]);
			map.addOverlay(polyline);   //增加折线
			// polyline.hide();
			polylines.push(polyline);
		}
	}

	function addMarker(points) {
	    //循环建立标注点
	    for(var i=0, pointsLen = points.length; i<pointsLen; i++) {
	        var point = new BMap.Point(points[i].lng, points[i].lat); //将标注点转化成地图上的点
	        var marker = new BMap.Marker(point); //将点转化成标注点
	        map.addOverlay(marker);  //将标注点添加到地图上
	        //添加监听事件
	        (function() {
	            var thePoint = points[i];
	            marker.addEventListener("click",
	                function() {
	                showInfo(this,thePoint);
	            });
	         })();
	    }
	}

	//随机生成新的点，加入到轨迹中。
	var offset = 0;
	function adynamicLines(){
		if (!flow) return;
		// for (var i = 0; i < polylines.length; i++) {
		// 	polylines[i].hide();
		// }
		for (var i = 0; i < polylines.length; i++) {
			if ( i % 3 == offset) {
				polylines[i].show();
			} else {
				polylines[i].hide();
			}
		}
		offset += 1;
		if (offset == 3) {offset = 0;}
    	setTimeout(adynamicLines, 300);
	}

	function removeFlow(){
		flow = false;
		for (var i = 0; i < polylines.length; i++) {
				map.removeOverlay(polylines[i]);
		}
	}

</script>
